#!/usr/bin/env ruby
require 'turbulence'
require 'turbulence/scatter_plot_generator'
require 'fileutils'
require 'launchy'
TURBULENCE_PATH = File.join(File.absolute_path(File.dirname(__FILE__)), "..")

def path_to_template(filename)
  File.join(TURBULENCE_PATH, "template", filename)
end

def copy_templates_into(directory)
  FileUtils.cp path_to_template('turbulence.html'), directory
  FileUtils.cp path_to_template('highcharts.js'), directory
  FileUtils.cp path_to_template('jquery.min.js'), directory
end

def generate_bundle_for(git_repo)
  FileUtils.mkdir_p("turbulence")
  Dir.chdir("turbulence") do
    copy_templates_into(Dir.pwd)  
    File.open("cc.js", "w") do |f| 
      f.write Turbulence::ScatterPlotGenerator.from(Turbulence.new(git_repo).metrics)
    end
  end
end

def open_bundle(directory)
  Launchy.open("file://#{directory}/turbulence/turbulence.html")
end
generate_bundle_for Dir.pwd
open_bundle Dir.pwd